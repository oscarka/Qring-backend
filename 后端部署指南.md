# 后端部署指南

## 📋 部署前准备

### 1. 检查清单
- [x] 环境变量配置已添加
- [x] Procfile 已创建
- [x] Dockerfile 已创建（可选）
- [x] .env.example 已创建
- [x] 错误处理已添加
- [x] CORS 配置已改进

---

## 🚀 部署方式

### 方式1：Railway 部署（推荐）

#### 步骤1：准备文件
确保以下文件存在：
- `qring_api_server.py` - 主应用文件
- `requirements.txt` - Python依赖
- `Procfile` - Railway启动配置
- `.env.example` - 环境变量示例

#### 步骤2：创建Railway项目
1. 访问 [Railway](https://railway.app)
2. 创建新项目
3. 选择 "Deploy from GitHub repo" 或 "Empty Project"

#### 步骤3：配置环境变量
在Railway项目设置中添加以下环境变量：

```
FLASK_ENV=production
FLASK_DEBUG=False
PORT=5002
HOST=0.0.0.0
CORS_ORIGINS=https://your-frontend-domain.com
```

**重要：**
- `CORS_ORIGINS` 应设置为你的前端域名（多个用逗号分隔）
- Railway会自动设置 `PORT`，但可以手动指定
- 如果前端也在Railway，可以使用相对路径 `/api`

#### 步骤4：部署
1. 连接GitHub仓库或上传代码
2. Railway会自动检测 `Procfile` 并启动服务
3. 等待部署完成

#### 步骤5：获取部署URL
- Railway会提供一个URL，例如：`https://your-backend.railway.app`
- 在iOS App中使用这个URL作为服务器地址
- 在前端环境变量中设置：`VITE_API_BASE=https://your-backend.railway.app/api`

---

### 方式2：Google Cloud Run 部署

#### 步骤1：准备Dockerfile
确保 `Dockerfile` 存在（已创建）

#### 步骤2：构建和推送镜像
```bash
# 设置项目ID
export PROJECT_ID=your-project-id
gcloud config set project $PROJECT_ID

# 构建镜像
gcloud builds submit --tag gcr.io/$PROJECT_ID/qring-api

# 或者使用本地Docker
docker build -t gcr.io/$PROJECT_ID/qring-api .
docker push gcr.io/$PROJECT_ID/qring-api
```

#### 步骤3：部署到Cloud Run
```bash
gcloud run deploy qring-api \
  --image gcr.io/$PROJECT_ID/qring-api \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --port 5002 \
  --set-env-vars FLASK_ENV=production,FLASK_DEBUG=False,CORS_ORIGINS=https://your-frontend-domain.com
```

#### 步骤4：获取部署URL
- Cloud Run会提供一个URL，例如：`https://qring-api-xxx.run.app`
- 在iOS App和前端中使用这个URL

---

### 方式3：传统VPS部署（Nginx + Gunicorn）

#### 步骤1：安装依赖
```bash
# 在VPS上
sudo apt update
sudo apt install python3-pip nginx

# 安装Python依赖
pip3 install -r requirements.txt
pip3 install gunicorn
```

#### 步骤2：创建systemd服务
创建 `/etc/systemd/system/qring-api.service`：

```ini
[Unit]
Description=Qring API Server
After=network.target

[Service]
User=www-data
WorkingDirectory=/path/to/qring-api
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/gunicorn --bind 0.0.0.0:5002 --workers 4 qring_api_server:app
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 步骤3：配置Nginx
创建 `/etc/nginx/sites-available/qring-api`：

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 步骤4：启动服务
```bash
sudo systemctl enable qring-api
sudo systemctl start qring-api
sudo nginx -t
sudo systemctl reload nginx
```

---

## 🔧 环境变量说明

### 必需的环境变量

| 变量名 | 说明 | 默认值 | 示例 |
|--------|------|--------|------|
| `FLASK_ENV` | Flask环境 | `development` | `production` |
| `FLASK_DEBUG` | 调试模式 | `False` | `False` |
| `HOST` | 监听地址 | `0.0.0.0` | `0.0.0.0` |
| `PORT` | 监听端口 | `5002` | `5002` |
| `CORS_ORIGINS` | 允许的CORS来源 | `*` | `https://yourdomain.com` |

### 生产环境推荐配置

```bash
FLASK_ENV=production
FLASK_DEBUG=False
HOST=0.0.0.0
PORT=5002
CORS_ORIGINS=https://your-frontend-domain.com,https://www.your-frontend-domain.com
```

---

## 📝 部署后验证

### 1. 健康检查
```bash
curl https://your-backend-domain.com/api/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2025-01-01T12:00:00",
  "version": "1.0.0",
  "data_file": "qring_data.json",
  "data_file_exists": true
}
```

### 2. 测试API接口
```bash
curl https://your-backend-domain.com/api/stats
```

### 3. 检查CORS
在浏览器控制台测试前端是否能正常请求API

---

## ⚠️ 注意事项

### 数据持久化
- **Railway/Cloud Run**: 使用临时存储，数据会在重启后丢失
  - **解决方案1**: 使用Railway的Volume功能持久化 `qring_data.json`
  - **解决方案2**: 迁移到数据库（PostgreSQL、MongoDB等）

### 安全性
- 生产环境必须使用HTTPS
- 限制CORS来源，不要使用 `*`
- 考虑添加API密钥验证（可选）

### 性能
- 当前使用JSON文件存储，适合小规模使用
- 如果数据量大（>10万条），建议迁移到数据库
- 考虑添加缓存机制（Redis）

### 监控和日志
- Railway/Cloud Run 提供内置日志查看
- 考虑添加错误监控（Sentry等）
- 定期备份数据文件

---

## 🔄 更新部署

### Railway
- 推送代码到GitHub，Railway会自动重新部署
- 或在Railway控制台手动触发重新部署

### Cloud Run
```bash
gcloud run deploy qring-api --image gcr.io/$PROJECT_ID/qring-api
```

### VPS
```bash
sudo systemctl restart qring-api
```

---

## 📞 故障排查

### 问题1：部署后无法访问
- 检查环境变量 `PORT` 是否正确
- 检查防火墙规则
- 检查服务是否正在运行

### 问题2：CORS错误
- 检查 `CORS_ORIGINS` 环境变量
- 确保前端域名在允许列表中

### 问题3：数据丢失
- Railway/Cloud Run使用临时存储
- 需要配置持久化存储或迁移到数据库

### 问题4：500错误
- 检查日志输出
- 检查数据文件权限
- 检查环境变量配置

---

## ✅ 部署完成检查清单

- [ ] 健康检查端点可访问
- [ ] API接口正常响应
- [ ] CORS配置正确
- [ ] 环境变量已配置
- [ ] 数据持久化已配置（如果需要）
- [ ] iOS App可以连接
- [ ] 前端可以正常获取数据
- [ ] 日志正常输出

